#!/usr/bin/env node

'use strict';

const path = require('path');
const resolver = require('opensphere-build-resolver/utils');
const shell = require('shelljs');


/**
 * Directory containing build artifacts generated by `bits-resolver`.
 * @type {string}
 */
const buildDir = '.build';


/**
 * Path to the build directory.
 * @type {string}
 */
const buildPath = path.join(__dirname, buildDir);


/**
 * Resources for tuiEditor
 * @type {Array<Object>}
 */
const tuiEditorResources = [
  {
    source: resolver.resolveModulePath('markdown-it/dist', __dirname),
    scripts: ['markdown-it.min.js']
  },
  {
    source: resolver.resolveModulePath('to-mark/dist', __dirname),
    scripts: ['to-mark.min.js']
  },
  {
    source: resolver.resolveModulePath('highlight.js/lib', __dirname),
    scripts: ['highlight.js']
  },
  {
    source: resolver.resolveModulePath('squire-rte/build', __dirname),
    scripts: ['squire.js']
  },
  {
    source: resolver.resolveModulePath('codemirror/lib', __dirname),
    scripts: ['codemirror.js']
  },
  {
    source: resolver.resolveModulePath('tui-code-snippet/dist', __dirname),
    scripts: ['tui-code-snippet.min.js']
  },
  {
    source: resolver.resolveModulePath('tui-editor/dist', __dirname),
    scripts: [
      'tui-editor-Viewer.min.js',
      'tui-editor-Editor.min.js',
      'tui-editor-extTable.min.js'
    ]
  }
];


/**
 * @param {Array<Object>} resources
 * @param {string} output
 * @param {string=} opt_optimzationLevel
 */
var vendorMinify = function(resources, output, opt_optimzationLevel) {
  var fileList = [];
  resources.forEach(function(lib) {
    lib.scripts.forEach(function(script) {
      fileList = fileList.concat(lib.source + '/' + script);
    });
  });

  var opLevel = opt_optimzationLevel || 'SIMPLE_OPTIMIZATIONS';
  var args = '--compilation_level ' + opLevel + ' ' + fileList.join(' ') + ' --js_output_file ' + output;
  console.log(args);
  shell.exec(resolver.resolveModulePath('opensphere-build-closure-helper') + '/os-compile.js ' + args);
};

vendorMinify(tuiEditorResources, 'vendor/os-minified/os-tui-editor.min.js');
